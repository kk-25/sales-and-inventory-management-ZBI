name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: [ "develop" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  security-events: write

jobs:

  build-and-test:
    name: Build, Lint
    runs-on: ubuntu-latest
    
    env:
      SECRET_KEY: ${{ secrets.DJANGO_CI_KEY }}
      DEBUG: 'False'
      DB_NAME: 'db.sqlite3'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 bandit coverage
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # LINTING (Czystość kodu)
      - name: Lint with flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      # SYSTEM CHECK (Czy Django w ogóle działa)
      - name: Django System Check
        run: python manage.py check

      # UNIT & INTEGRATION TESTS 

  # ---------------------------------------------------
  # JOB 2: SECURITY SAST & SCA (Bezpieczeństwo statyczne)
  # ---------------------------------------------------
  security-scans:
    name: Security Checks (SAST, SCA, Secrets)
    runs-on: ubuntu-latest
    needs: build-and-test # Uruchom tylko, jeśli build przeszedł
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      # 1. SAST: Bandit (uruchamiany bezpośrednio)
      - name: Install and Run Bandit (SAST)
        run: |
          pip install bandit 
          bandit -r . -ll || true
          bandit -r . -ll -f json -o bandit_report.json || true

      - name: Upload Bandit Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-bandit-report
          path: bandit_report.json
# -------------------------------------------------------
      # 2. TRIVY (SCA & Secrets) - Oficjalna Akcja
      # Konfiguracja: scan-type: 'fs' (FileSystem)
      # -------------------------------------------------------
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'        # KLUCZOWE: Skanuj pliki, nie obrazy Dockera
          scan-ref: '.'          # Skanuj obecny katalog
          hide-progress: false
          format: 'table'
          output: 'trivy_report.txt'
          exit-code: '0'         # 0 = nie blokuj pipeline (dla nauki), 1 = blokuj
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln,secret,config' # Skanuj podatności, sekrety i config

      - name: Upload Trivy Report
        if: always()
        run: cat trivy_report.txt
      
      - name: Archive Trivy Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sca-trivy-report
          path: trivy_report.txt

  # ---------------------------------------------------
  # JOB 3: DAST (Dynamiczne skanowanie)
  # ---------------------------------------------------
  dast-scan:
    name: DAST (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      # Aby zrobić DAST, aplikacja musi działać.
      # Uruchamiamy ją w tle w kontenerze/procesie, a potem skanujemy.
      - name: Set up Python & Run App
        env:
          SECURE_SSL_REDIRECT: "False"
          DEBUG: "True"
        run: |
          pip install -r requirements.txt gunicorn
          python manage.py migrate
          gunicorn --bind 0.0.0.0:8000 --timeout 180 --workers 1 InventoryMS.wsgi:application &
          sleep 20
          curl -f http://localhost:8000/
          # Czekamy aż wstanie

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.15.0
        with:
          target: 'http://localhost:8000'
          # Fail tylko na bardzo poważnych błędach, bo ZAP często zgłasza "false positives"
          fail_action: false 
          allow_issue_writing: false  # <--- Wyłączamy próbę tworzenia Issue
          cmd_options: '-a'

      - name: Upload ZAP Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-report
          path: |
            report_zap_html.html
            report_zap_json.json


# ---------------------------------------------------
  # JOB 4: DEPLOY TO AZURE (Wdrożenie na prod)
  # ---------------------------------------------------
  deploy:
    name: Deploy to Azure Web App
    runs-on: ubuntu-latest
    # Deploy wykonaj TYLKO, jeśli przeszły testy jakości, SAST i DAST
    needs: [build-and-test, security-scans, dast-scan] 
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      # Logowanie do Azure (opcjonalne przy Publish Profile, ale dobra praktyka)
      # W tym prostym scenariuszu pomijamy 'azure/login', polegamy na profilu.

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v2
        with:
          app-name: 'zbi-inventory-app'  # np. zbi-sales-app
          slot-name: 'production'
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: .
          # Opcjonalnie: komenda startowa, jeśli nie zadziała automatycznie
          # startup-command: 'gunicorn --bind=0.0.0.0 --timeout 600 twoj_projekt.wsgi'
